name: Build
on:
  push:
    branches:
      - master
  pull_request:
    types: [opened, synchronize, reopened]

env:
  # Customize the CMake build type here (Release, Debug, RelWithDebInfo, etc.)
  BUILD_TYPE: Release

jobs:
  build:
    runs-on: windows-latest
    steps:
    - uses: actions/checkout@v2
      with:
        fetch-depth: 0
          
    - name: Install wget
      shell: bash
      run: |
        choco install wget --no-progress
        
    - name: Prepare Sonar scanner
      shell: bash
      run: |
        wget -nv https://binaries.sonarsource.com/Distribution/sonar-scanner-cli/sonar-scanner-cli-4.7.0.2747-windows.zip
        unzip -q sonar-scanner-cli-4.7.0.2747-windows.zip
        echo "${{github.workspace}}/sonar-scanner-4.7.0.2747-windows/bin/" >> $GITHUB_PATH
         
    - name: install vcpkg
      shell: bash
      run: |
        cd ..
        git clone https://github.com/Microsoft/vcpkg.git
        cd vcpkg
        sh bootstrap-vcpkg.sh
        ./vcpkg.exe integrate install
        ./vcpkg.exe --triplet x64-windows install ms-gsl
        
    - name: Configure CMake
      run: |
        cmake -B ${{github.workspace}}/out/build -DCMAKE_TOOLCHAIN_FILE=${{github.workspace}}/../vcpkg/scripts/buildsystems/vcpkg.cmake -DCMAKE_BUILD_TYPE=${{env.BUILD_TYPE}} -DPATCH_VERSION=${{ github.run_number }} -DWITH_GTEST=OFF
    - name: Build
      run: |
        cmake --build ${{github.workspace}}/out/build --config ${{env.BUILD_TYPE}}
        
    - name: SonarCloud Scan
      shell: bash
      run: |
        sonar-scanner.bat
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
